name: Create Repository from Issue

on:
issues:
types: [opened, labeled]

jobs:
create-repo:
runs-on: ubuntu-latest
# â€œcreate-repoâ€ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸIssueã®ã¿å‡¦ç†
if: contains(github.event.issue.labels.*.name, â€˜create-repoâ€™)

```
steps:
  - name: Checkout repository
    uses: actions/checkout@v4
  
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'
  
  - name: Parse issue body
    id: parse-issue
    env:
      ISSUE_BODY: ${{ github.event.issue.body }}
    run: |
      # Issueã®æœ¬æ–‡ã‚’è§£æã—ã¦JSONå½¢å¼ã«å¤‰æ›
      cat > parse-issue.js << 'SCRIPT'
      const issueBody = process.env.ISSUE_BODY;
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const extractField = (label) => {
        const regex = new RegExp(`### ${label}\\s*([\\s\\S]*?)(?=\\n###|$)`, 'i');
        const match = issueBody.match(regex);
        return match ? match[1].trim() : '';
      };
      
      const repoName = extractField('ãƒªãƒã‚¸ãƒˆãƒªå');
      const projectType = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—');
      const techStack = extractField('æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯');
      const description = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜');
      const features = extractField('å¿…è¦ãªæ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰');
      const visibility = extractField('ãƒªãƒã‚¸ãƒˆãƒªã®å…¬é–‹è¨­å®š');
      const license = extractField('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹');
      const notes = extractField('ãã®ä»–ã®è¦æœ›ï¼ˆä»»æ„ï¼‰');
      
      // Claudeã«é€ã‚‹å½¢å¼ã«æ•´å½¢
      const prompt = `
```

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ

## åŸºæœ¬æƒ…å ±

- ãƒªãƒã‚¸ãƒˆãƒªå: ${repoName}
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—: ${projectType}
- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ${techStack}
- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: ${license}

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜

${description}

${features ? `## å¿…è¦ãªæ©Ÿèƒ½\n${features}` : â€˜â€™}

${notes ? `## ãã®ä»–ã®è¦æœ›\n${notes}` : â€˜â€™}

å®Œå…¨ã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
`;

```
      console.log(JSON.stringify({
        repo_name: repoName.toLowerCase().replace(/\s+/g, '-'),
        visibility: visibility.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ') ? 'private' : 'public',
        prompt: prompt
      }));
      SCRIPT
      
      PARSED=$(node parse-issue.js)
      echo "data<<EOF" >> $GITHUB_OUTPUT
      echo "$PARSED" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT
  
  - name: Call Claude API
    id: claude
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    run: |
      PROMPT=$(echo '${{ steps.parse-issue.outputs.data }}' | jq -r '.prompt')
      
      cat > call-claude.js << 'SCRIPT'
      const https = require('https');
      
      const prompt = process.env.PROMPT;
      
      const requestData = JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 8000,
        messages: [{
          role: "user",
          content: `${prompt}
```

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã€èª¬æ˜ä¸è¦ï¼‰:

{
â€œrepo_nameâ€: â€œãƒªãƒã‚¸ãƒˆãƒªåâ€,
â€œdescriptionâ€: â€œ1è¡Œã®èª¬æ˜â€,
â€œfilesâ€: {
â€œREADME.mdâ€: â€œå†…å®¹â€,
â€œsrc/index.jsâ€: â€œå†…å®¹â€
}
}`
}]
});

```
      const options = {
        hostname: 'api.anthropic.com',
        port: 443,
        path: '/v1/messages',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(requestData),
          'x-api-key': process.env.ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01'
        }
      };
      
      const req = https.request(options, (res) => {
        let body = '';
        res.on('data', (chunk) => body += chunk);
        res.on('end', () => {
          try {
            const response = JSON.parse(body);
            const content = response.content[0].text;
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              const parsed = JSON.parse(jsonMatch[0]);
              console.log(JSON.stringify(parsed, null, 2));
            } else {
              console.error('JSON not found');
              process.exit(1);
            }
          } catch (e) {
            console.error('Error:', e.message);
            process.exit(1);
          }
        });
      });
      
      req.on('error', (e) => {
        console.error('Request error:', e.message);
        process.exit(1);
      });
      
      req.write(requestData);
      req.end();
      SCRIPT
      
      export PROMPT="$PROMPT"
      CLAUDE_OUTPUT=$(node call-claude.js)
      
      echo "output<<EOF" >> $GITHUB_OUTPUT
      echo "$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT
  
  - name: Create repository and push code
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
      VISIBILITY: ${{ fromJSON(steps.parse-issue.outputs.data).visibility }}
    run: |
      REPO_NAME=$(echo "$CLAUDE_OUTPUT" | jq -r '.repo_name')
      REPO_DESC=$(echo "$CLAUDE_OUTPUT" | jq -r '.description')
      
      # ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/user/repos \
        -d "{\"name\":\"$REPO_NAME\",\"description\":\"$REPO_DESC\",\"private\":$([ "$VISIBILITY" = "private" ] && echo true || echo false)}"
      
      # ãƒªãƒã‚¸ãƒˆãƒªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      mkdir -p /tmp/new-repo
      cd /tmp/new-repo
      git init
      git config user.name "Claude Bot"
      git config user.email "claude-bot@github-actions"
      git branch -M main
      
      # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      echo "$CLAUDE_OUTPUT" | jq -r '.files | to_entries[] | @json' | while read -r entry; do
        filepath=$(echo "$entry" | jq -r '.key')
        content=$(echo "$entry" | jq -r '.value')
        mkdir -p "$(dirname "$filepath")"
        echo "$content" > "$filepath"
      done
      
      # ãƒ—ãƒƒã‚·ãƒ¥
      git add .
      git commit -m "Initial commit from Issue #${{ github.event.issue.number }}"
      git remote add origin "https://$GITHUB_TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git"
      git push -u origin main
      
      echo "REPO_URL=https://github.com/${{ github.repository_owner }}/$REPO_NAME" >> $GITHUB_ENV
  
  - name: Comment on issue
    uses: actions/github-script@v7
    with:
      github-token: ${{ secrets.GITHUB_TOKEN }}
      script: |
        const repoUrl = process.env.REPO_URL;
        github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body: `## âœ… ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼\n\nğŸ”— [${repoUrl}](${repoUrl})\n\nClaudeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`
        });
        
        // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        github.rest.issues.update({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'closed'
        });
```
