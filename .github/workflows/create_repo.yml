name: Create Repository from Issue

on:
issues:
types: [opened]

permissions:
contents: read
issues: write

jobs:
create-repo:
runs-on: ubuntu-latest
if: contains(github.event.issue.labels.*.name, â€˜create_repoâ€™)

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
  
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'
  
  - name: Parse issue body
    id: parse-issue
    env:
      ISSUE_BODY: ${{ github.event.issue.body }}
    run: |
      cat > parse-issue.js << 'ENDOFSCRIPT'
      const issueBody = process.env.ISSUE_BODY;
      
      const extractField = (label) => {
        const regex = new RegExp('### ' + label + '\\s*([\\s\\S]*?)(?=\\n###|$)', 'i');
        const match = issueBody.match(regex);
        return match ? match[1].trim() : '';
      };
      
      const repoName = extractField('ãƒªãƒã‚¸ãƒˆãƒªå');
      const projectType = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—');
      const techStack = extractField('æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯');
      const description = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜');
      const features = extractField('å¿…è¦ãªæ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰');
      const visibility = extractField('ãƒªãƒã‚¸ãƒˆãƒªã®å…¬é–‹è¨­å®š');
      const license = extractField('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹');
      const notes = extractField('ãã®ä»–ã®è¦æœ›ï¼ˆä»»æ„ï¼‰');
      
      const promptText = '\n# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n## åŸºæœ¬æƒ…å ±\n- ãƒªãƒã‚¸ãƒˆãƒªå: ' + repoName + '\n- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—: ' + projectType + '\n- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ' + techStack + '\n- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: ' + license + '\n\n## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜\n' + description + '\n\n' + (features ? '## å¿…è¦ãªæ©Ÿèƒ½\n' + features + '\n\n' : '') + (notes ? '## ãã®ä»–ã®è¦æœ›\n' + notes + '\n\n' : '') + 'å®Œå…¨ã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\nREADME.mdã«ã¯è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’å«ã‚ã¦ãã ã•ã„ã€‚\n\n## é‡è¦ï¼šGitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å«ã‚ã‚‹\n\nä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š\n\n.github/workflows/claude-feature.yml\n\nã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã§IssueãŒä½œæˆã•ã‚ŒãŸã¨ãã«ã€ClaudeãŒè‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦Pull Requestã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¦ä»¶ï¼š\n1. Issueã« "feature" ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ä½œæˆã•ã‚ŒãŸã¨ãï¼ˆopenedï¼‰ã«èµ·å‹•\n2. ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼šon.issues.types ã¯ ["opened"] ã®ã¿ï¼ˆlabeledã¯å«ã‚ãªã„ï¼‰\n3. æ¡ä»¶ï¼šcontains(github.event.issue.labels.*.name, \'feature\')\n4. Issueæœ¬æ–‡ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’èª­ã¿å–ã‚‹\n5. Claude APIã‚’å‘¼ã³å‡ºã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ\n6. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒ "feature/issue-{ç•ªå·}" ã‚’ä½œæˆ\n7. ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆ\n8. Pull Requestã‚’ä½œæˆï¼ˆIssueç•ªå·ã‚’å‚ç…§ï¼‰\n9. ANTHROPIC_API_KEY ã¯ Secrets ã‹ã‚‰èª­ã¿å–ã‚‹\n10. permissions: contents: write, issues: write, pull-requests: write ã‚’è¨­å®š\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ¢ãƒ‡ãƒ«ã¯ claude-sonnet-4-20250514 ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n\n## é‡è¦ï¼šIssueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å«ã‚ã‚‹\n\nä»¥ä¸‹ã®Issueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š\n\n.github/ISSUE_TEMPLATE/feature_request.yml\n.github/ISSUE_TEMPLATE/bug_report.yml\n.github/ISSUE_TEMPLATE/enhancement.yml\n\nIssueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¦ä»¶ï¼š\n\n### feature_request.yml:\n- name: æ–°æ©Ÿèƒ½ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n- labels: ["feature"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€æœŸå¾…ã™ã‚‹å‹•ä½œã€è¿½åŠ æƒ…å ±ï¼ˆä»»æ„ï¼‰\n\n### bug_report.yml:\n- name: ãƒã‚°å ±å‘Š\n- labels: ["bug"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šãƒã‚°ã®èª¬æ˜ã€å†ç¾æ‰‹é †ã€æœŸå¾…ã™ã‚‹å‹•ä½œã€å®Ÿéš›ã®å‹•ä½œã€ç’°å¢ƒæƒ…å ±ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆä»»æ„ï¼‰\n\n### enhancement.yml:\n- name: æ”¹å–„ææ¡ˆ\n- labels: ["enhancement"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šæ”¹å–„ã—ãŸã„æ©Ÿèƒ½ã€ææ¡ˆå†…å®¹ã€ãƒ¡ãƒªãƒƒãƒˆ\n\nã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n';
      
      console.log(JSON.stringify({
        repo_name: repoName.toLowerCase().replace(/\s+/g, '-'),
        visibility: visibility.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ') ? 'private' : 'public',
        prompt: promptText
      }));
      ENDOFSCRIPT
      
      PARSED=$(node parse-issue.js)
      echo "data<<EOF" >> $GITHUB_OUTPUT
      echo "$PARSED" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT
  
  - name: Call Claude API
    id: claude
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    run: |
      PROMPT=$(echo '${{ steps.parse-issue.outputs.data }}' | jq -r '.prompt')
      
      cat > call-claude.js << 'ENDOFSCRIPT'
      const https = require('https');
      
      const prompt = process.env.PROMPT;
      
      const requestData = JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 32000,
        messages: [{
          role: "user",
          content: prompt + '\n\nä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã€èª¬æ˜ä¸è¦ï¼‰:\n\n{\n  "repo_name": "ãƒªãƒã‚¸ãƒˆãƒªå",\n  "description": "1è¡Œã®èª¬æ˜",\n  "files": {\n    "README.md": "å†…å®¹",\n    ".github/workflows/claude-feature.yml": "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å†…å®¹",\n    ".github/ISSUE_TEMPLATE/feature_request.yml": "æ©Ÿèƒ½ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    ".github/ISSUE_TEMPLATE/bug_report.yml": "ãƒã‚°å ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    ".github/ISSUE_TEMPLATE/enhancement.yml": "æ”¹å–„ææ¡ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    "src/index.js": "å†…å®¹"\n  }\n}\n\nå¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼š\n- .github/workflows/claude-feature.ymlï¼ˆIssueã‹ã‚‰PRè‡ªå‹•ä½œæˆï¼‰\n- .github/ISSUE_TEMPLATE/feature_request.yml\n- .github/ISSUE_TEMPLATE/bug_report.yml\n- .github/ISSUE_TEMPLATE/enhancement.yml\n\nã“ã‚Œã‚‰ã¯å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚'
        }]
      });
      
      const options = {
        hostname: 'api.anthropic.com',
        port: 443,
        path: '/v1/messages',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(requestData),
          'x-api-key': process.env.ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01'
        }
      };
      
      const req = https.request(options, (res) => {
        let body = '';
        res.on('data', (chunk) => body += chunk);
        res.on('end', () => {
          try {
            const response = JSON.parse(body);
            
            if (response.error) {
              console.error('API Error:', response.error);
              process.exit(1);
            }
            
            if (!response.content || !response.content[0]) {
              console.error('Invalid response structure');
              process.exit(1);
            }
            
            const content = response.content[0].text;
            
            // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              try {
                const parsed = JSON.parse(jsonMatch[0]);
                console.log(JSON.stringify(parsed, null, 2));
              } catch (parseError) {
                console.error('JSON Parse Error:', parseError.message);
                console.error('Position:', parseError.message.match(/\d+/)?.[0]);
                // JSONãŒå¤§ãã™ãã‚‹å ´åˆã¯ä¸€éƒ¨ã ã‘è¡¨ç¤º
                const jsonText = jsonMatch[0];
                if (jsonText.length > 5000) {
                  console.error('JSON too large, showing first/last 1000 chars');
                  console.error('First 1000:', jsonText.substring(0, 1000));
                  console.error('Last 1000:', jsonText.substring(jsonText.length - 1000));
                } else {
                  console.error('Full JSON:', jsonText);
                }
                process.exit(1);
              }
            } else {
              console.error('JSON not found in response');
              process.exit(1);
            }
          } catch (e) {
            console.error('Error:', e.message);
            process.exit(1);
          }
        });
      });
      
      req.on('error', (e) => {
        console.error('Request error:', e.message);
        process.exit(1);
      });
      
      req.write(requestData);
      req.end();
      ENDOFSCRIPT
      
      export PROMPT="$PROMPT"
      CLAUDE_OUTPUT=$(node call-claude.js)
      
      echo "output<<EOF" >> $GITHUB_OUTPUT
      echo "$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT
  
  - name: Create repository
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
      VISIBILITY: ${{ fromJSON(steps.parse-issue.outputs.data).visibility }}
    run: |
      REPO_NAME=$(echo "$CLAUDE_OUTPUT" | jq -r '.repo_name')
      REPO_DESC=$(echo "$CLAUDE_OUTPUT" | jq -r '.description')
      
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/user/repos \
        -d "{\"name\":\"$REPO_NAME\",\"description\":\"$REPO_DESC\",\"private\":$([ "$VISIBILITY" = "private" ] && echo true || echo false)}"
      
      sleep 2
      
      echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
  
  - name: Clone and setup repository
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    run: |
      REPO_NAME="${{ env.REPO_NAME }}"
      
      git config --global user.name "Claude Bot"
      git config --global user.email "claude-bot@github-actions"
      
      mkdir -p /tmp/new-repo
      cd /tmp/new-repo
      git init
      git branch -M main
      
      echo "$CLAUDE_OUTPUT" | jq -r '.files | to_entries[] | @json' | while read -r entry; do
        filepath=$(echo "$entry" | jq -r '.key')
        content=$(echo "$entry" | jq -r '.value')
        mkdir -p "$(dirname "$filepath")"
        echo "$content" > "$filepath"
      done
      
      git add .
      git commit -m "Initial commit from Issue #${{ github.event.issue.number }}"
      git remote add origin "https://$GITHUB_TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git"
      git push -u origin main
      
      echo "REPO_URL=https://github.com/${{ github.repository_owner }}/$REPO_NAME" >> $GITHUB_ENV
  
  - name: Setup Secrets in new repository
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    run: |
      REPO_NAME="${{ env.REPO_NAME }}"
      OWNER="${{ github.repository_owner }}"
      
      # Get repository public key
      PUBLIC_KEY_RESPONSE=$(curl -s \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/actions/secrets/public-key")
      
      PUBLIC_KEY=$(echo "$PUBLIC_KEY_RESPONSE" | jq -r '.key')
      KEY_ID=$(echo "$PUBLIC_KEY_RESPONSE" | jq -r '.key_id')
      
      # Encrypt the secret using libsodium
      cat > encrypt-secret.js << 'ENCRYPTSCRIPT'
      const sodium = require('libsodium-wrappers');
      
      (async () => {
        await sodium.ready;
        
        const publicKey = process.env.PUBLIC_KEY;
        const secret = process.env.SECRET_VALUE;
        
        const binkey = sodium.from_base64(publicKey, sodium.base64_variants.ORIGINAL);
        const binsec = sodium.from_string(secret);
        
        const encBytes = sodium.crypto_box_seal(binsec, binkey);
        const output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL);
        
        console.log(output);
      })();
      ENCRYPTSCRIPT
      
      # Install libsodium-wrappers
      npm install libsodium-wrappers
      
      # Encrypt the API key
      export PUBLIC_KEY="$PUBLIC_KEY"
      export SECRET_VALUE="$ANTHROPIC_API_KEY"
      ENCRYPTED_VALUE=$(node encrypt-secret.js)
      
      # Create the secret
      curl -X PUT \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/actions/secrets/ANTHROPIC_API_KEY" \
        -d "{\"encrypted_value\":\"$ENCRYPTED_VALUE\",\"key_id\":\"$KEY_ID\"}"
      
      echo "âœ… ANTHROPIC_API_KEY has been added to $REPO_NAME"
  
  - name: Create labels in new repository
    env:
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    run: |
      REPO_NAME="${{ env.REPO_NAME }}"
      OWNER="${{ github.repository_owner }}"
      
      # Create "feature" label
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
        -d '{"name":"feature","description":"New feature or request","color":"0e8a16"}'
      
      # Create "bug" label
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
        -d '{"name":"bug","description":"Something is not working","color":"d73a4a"}'
      
      # Create "enhancement" label
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
        -d '{"name":"enhancement","description":"Improvement to existing feature","color":"a2eeef"}'
      
      # Create "question" label
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
        -d '{"name":"question","description":"Further information is requested","color":"d876e3"}'
      
      # Create "warning" label
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
        -d '{"name":"warning","description":"Needs attention","color":"fbca04"}'
      
      echo "âœ… Labels have been created in $REPO_NAME"
  
  - name: Comment on issue
    uses: actions/github-script@v7
    with:
      github-token: ${{ secrets.GITHUB_TOKEN }}
      script: |
        const repoUrl = process.env.REPO_URL;
        await github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body: `## âœ… ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼\n\nğŸ”— [${repoUrl}](${repoUrl})\n\n### ğŸ¤– AIæ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™\n\næ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã§Issueã‚’ä½œæˆã™ã‚‹ã¨ã€ClaudeãŒè‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦Pull Requestã‚’ä½œæˆã—ã¾ã™ã€‚\n\n**ä½¿ã„æ–¹ï¼š**\n1. æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã§Issueã‚’ä½œæˆ\n2. "feature" ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ \n3. å®Ÿè£…ã—ã¦ã»ã—ã„æ©Ÿèƒ½ã‚’è¨˜è¿°\n4. æ•°åˆ†å¾Œã€è‡ªå‹•ã§PRãŒä½œæˆã•ã‚Œã¾ã™ï¼\n\nClaudeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`
        });
        
        await github.rest.issues.update({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'closed'
        });
