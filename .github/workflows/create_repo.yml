name: Create Repository from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  create-repo:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'create_repo')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Parse issue body
        id: parse-issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat > parse-issue.js << 'ENDOFSCRIPT'
          const issueBody = process.env.ISSUE_BODY;
          
          const extractField = (label) => {
            const regex = new RegExp('### ' + label + '\\s*([\\s\\S]*?)(?=\\n###|$)', 'i');
            const match = issueBody.match(regex);
            return match ? match[1].trim() : '';
          };
          
          const repoName = extractField('ãƒªãƒã‚¸ãƒˆãƒªå');
          const projectType = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—');
          const techStack = extractField('æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯');
          const description = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜');
          const features = extractField('å¿…è¦ãªæ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰');
          const visibility = extractField('ãƒªãƒã‚¸ãƒˆãƒªã®å…¬é–‹è¨­å®š');
          const license = extractField('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹');
          const notes = extractField('ãã®ä»–ã®è¦æœ›ï¼ˆä»»æ„ï¼‰');
          
          const promptText = '\n# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n## åŸºæœ¬æƒ…å ±\n- ãƒªãƒã‚¸ãƒˆãƒªå: ' + repoName + '\n- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—: ' + projectType + '\n- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ' + techStack + '\n- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: ' + license + '\n\n## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜\n' + description + '\n\n' + (features ? '## å¿…è¦ãªæ©Ÿèƒ½\n' + features + '\n\n' : '') + (notes ? '## ãã®ä»–ã®è¦æœ›\n' + notes + '\n\n' : '') + 'å®Œå…¨ã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\nREADME.mdã«ã¯è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’å«ã‚ã¦ãã ã•ã„ã€‚\n\n## é‡è¦ï¼šGitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å«ã‚ã‚‹\n\nä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š\n\n.github/workflows/claude-feature.yml\n\nã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã§IssueãŒä½œæˆã•ã‚ŒãŸã¨ãã«ã€ClaudeãŒæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã€è‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã‚’è¡Œã£ã¦Pull Requestã‚’ä½œæˆã™ã‚‹é«˜åº¦ãªæ©Ÿèƒ½ã§ã™ã€‚\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨ãªä»•æ§˜ï¼š\n\n```yaml\nname: Claude Feature Generator (Enhanced)\n\non:\n  issues:\n    types: [opened]\n\npermissions:\n  contents: write\n  issues: write\n  pull-requests: write\n\njobs:\n  generate-feature:\n    if: |\n      contains(github.event.issue.labels.*.name, \'feature\') ||\n      contains(github.event.issue.labels.*.name, \'bug\') ||\n      contains(github.event.issue.labels.*.name, \'enhancement\') ||\n      contains(github.event.issue.labels.*.name, \'refactor\')\n    runs-on: ubuntu-latest\n    permissions:\n      contents: write\n      issues: write\n      pull-requests: write\n    \n    steps:\n      - name: Checkout repository\n        uses: actions/checkout@v4\n      \n      - name: Gather repository context\n        run: |\n          echo "=== Repository Structure ===" > repo_context.txt\n          tree -L 3 -I \'bin|obj|node_modules|.git\' >> repo_context.txt 2>/dev/null || find . -maxdepth 3 -type f -not -path \'*/\\.*\' -not -path \'*/bin/*\' -not -path \'*/obj/*\' | head -100 >> repo_context.txt\n          echo -e "\\n=== Project Files ===" >> repo_context.txt\n          find . -name "*.csproj" -o -name "package.json" -o -name "*.sln" | head -10 | while read f; do echo "File: $f" >> repo_context.txt; cat "$f" >> repo_context.txt 2>/dev/null; done\n          echo -e "\\n=== Source Files ===" >> repo_context.txt\n          find . \\( -name "*.cs" -o -name "*.razor" -o -name "*.js" -o -name "*.py" -o -name "*.java" \\) | grep -v "/bin/" | grep -v "/obj/" | grep -v "/node_modules/" | head -30 | while read f; do echo -e "\\n### File: $f" >> repo_context.txt; cat "$f" >> repo_context.txt; echo -e "\\n---\\n" >> repo_context.txt; done\n      \n      - name: Generate feature code with Claude\n        env:\n          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}\n          ISSUE_TITLE: ${{ github.event.issue.title }}\n          ISSUE_BODY: ${{ github.event.issue.body }}\n          ISSUE_NUMBER: ${{ github.event.issue.number }}\n        run: |\n          git config --global user.name \'github-actions[bot]\'\n          git config --global user.email \'github-actions[bot]@users.noreply.github.com\'\n          git checkout -b feature/issue-${{ github.event.issue.number }}\n          \n          REPO_CONTEXT=$(cat repo_context.txt | head -c 100000)\n          ESCAPED_TITLE=$(echo "$ISSUE_TITLE" | jq -Rs .)\n          ESCAPED_BODY=$(echo "$ISSUE_BODY" | jq -Rs .)\n          ESCAPED_CONTEXT=$(echo "$REPO_CONTEXT" | jq -Rs .)\n          \n          PAYLOAD=$(jq -n --argjson title "$ESCAPED_TITLE" --argjson body "$ESCAPED_BODY" --argjson context "$ESCAPED_CONTEXT" \'{model: "claude-sonnet-4-20250514", max_tokens: 16000, messages: [{role: "user", content: "ã‚ãªãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ç†è§£ã—ãŸä¸Šã§ã€Issue ã®è¦æœ›ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚\\n\\n# ç¾åœ¨ã®ãƒªãƒã‚¸ãƒˆãƒª:\\n\\n\\($context)\\n\\n# Issue:\\n\\nã‚¿ã‚¤ãƒˆãƒ«: \\($title)\\n\\nè©³ç´°:\\n\\($body)\\n\\n# æŒ‡ç¤º:\\n\\n1. æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†æ™‚ã¯å®Œå…¨ãªå†…å®¹ã‚’å‡ºåŠ›\\n2. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æä¾›\\n3. å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ˜ç¤º\\n4. .github/workflows/ é…ä¸‹ã¯ä½œæˆãƒ»å¤‰æ›´ã—ãªã„\\n5. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ç†ç”±ã‚’èª¬æ˜\\n\\n# å‡ºåŠ›å½¢å¼:\\n\\n## ãƒ•ã‚¡ã‚¤ãƒ«: [ãƒ‘ã‚¹]\\nå¤‰æ›´ã‚¿ã‚¤ãƒ—: [CREATE/UPDATE/DELETE]\\nèª¬æ˜: [ç›®çš„]\\n\\n```[è¨€èª]\\n[å†…å®¹]\\n```"}]}\')\n          \n          response=$(curl -s -X POST "https://api.anthropic.com/v1/messages" -H "Content-Type: application/json" -H "x-api-key: $ANTHROPIC_API_KEY" -H "anthropic-version: 2023-06-01" -d "$PAYLOAD")\n          echo "$response" | jq \'.\' > claude_response.json\n          CLAUDE_TEXT=$(echo "$response" | jq -r \'.content[0].text // empty\')\n          \n          if [ -z "$CLAUDE_TEXT" ]; then\n            echo "Error: No response from Claude API"\n            cat claude_response.json\n            exit 1\n          fi\n          \n          echo "$CLAUDE_TEXT" > claude_output.txt\n          \n          echo "Parsing Claude response..."\n          grep -n "^## ãƒ•ã‚¡ã‚¤ãƒ«:" claude_output.txt | while IFS=: read -r line_num filepath_line; do\n            filepath=$(echo "$filepath_line" | sed \'s/^## ãƒ•ã‚¡ã‚¤ãƒ«: *//\' | sed \'s/^[[:space:]]*//\' | sed \'s/[[:space:]]*$//\')\n            \n            if [[ "$filepath" == .github/workflows/* ]]; then\n              echo "Skipping: $filepath (workflow restriction)"\n              echo "- \\`$filepath\\`: Skipped (workflow files)" >> skipped_files.txt\n              continue\n            fi\n            \n            change_type=$(sed -n "$((line_num+1))p" claude_output.txt | grep "å¤‰æ›´ã‚¿ã‚¤ãƒ—:" | sed \'s/å¤‰æ›´ã‚¿ã‚¤ãƒ—: *//\' | sed \'s/^[[:space:]]*//\' | sed \'s/[[:space:]]*$//\' | tr \'[:lower:]\' \'[:upper:]\')\n            description=$(sed -n "$((line_num+2))p" claude_output.txt | grep "èª¬æ˜:" | sed \'s/èª¬æ˜: *//\')\n            [ -z "$change_type" ] && change_type="UPDATE"\n            [ -z "$description" ] && description="No description"\n            \n            code_start=$(tail -n +$((line_num+1)) claude_output.txt | grep -n \'```\' | head -1 | cut -d: -f1)\n            if [ -n "$code_start" ]; then\n              code_start=$((line_num + code_start))\n              code_end=$(tail -n +$((code_start+1)) claude_output.txt | grep -n \'```\' | head -1 | cut -d: -f1)\n              \n              if [ -n "$code_end" ]; then\n                code_end=$((code_start + code_end))\n                echo "Processing: $change_type - $filepath"\n                \n                if [ "$change_type" = "DELETE" ]; then\n                  [ -f "$filepath" ] && rm -f "$filepath" && echo "- \\`$filepath\\`: $description" >> deleted_files.txt\n                else\n                  sed -n "$((code_start+1)),$((code_end-1))p" claude_output.txt > "$filepath.tmp"\n                  mkdir -p "$(dirname "$filepath")"\n                  mv "$filepath.tmp" "$filepath"\n                  [ -f "$filepath" ] && echo "- \\`$filepath\\`: $description" >> $( [ "$change_type" = "CREATE" ] && echo "created_files.txt" || echo "updated_files.txt" )\n                fi\n              fi\n            fi\n          done\n          \n          echo "# Implementation Summary" > IMPLEMENTATION_SUMMARY.md\n          for file in created_files.txt updated_files.txt deleted_files.txt skipped_files.txt; do\n            [ -f "$file" ] && cat "$file" >> IMPLEMENTATION_SUMMARY.md && echo "" >> IMPLEMENTATION_SUMMARY.md && rm "$file"\n          done\n          \n          git add .\n          [ -z "$(git diff --staged)" ] && echo "No changes" && exit 1\n          git commit -m "feat: implement $ISSUE_TITLE (issue #${{ github.event.issue.number }})"\n          git push origin feature/issue-${{ github.event.issue.number }}\n      \n      - name: Create Pull Request\n        run: |\n          ISSUE_NUMBER=${{ github.event.issue.number }}\n          ISSUE_TITLE="${{ github.event.issue.title }}"\n          if [[ "${{ contains(github.event.issue.labels.*.name, \'feature\') }}" == "true" ]]; then\n            BRANCH="feature/issue-${ISSUE_NUMBER}"; PREFIX="feat"\n          elif [[ "${{ contains(github.event.issue.labels.*.name, \'bug\') }}" == "true" ]]; then\n            BRANCH="fix/issue-${ISSUE_NUMBER}"; PREFIX="fix"\n          elif [[ "${{ contains(github.event.issue.labels.*.name, \'refactor\') }}" == "true" ]]; then\n            BRANCH="feature/issue-${ISSUE_NUMBER}"; PREFIX="refactor"\n          else\n            BRANCH="enhance/issue-${ISSUE_NUMBER}"; PREFIX="enhance"\n          fi\n          PR_PAYLOAD=$(jq -n --arg title "${PREFIX}: ${ISSUE_TITLE} (fixes #${ISSUE_NUMBER})" --arg issue_num "${ISSUE_NUMBER}" --arg head "${BRANCH}" --arg base "master" \'{title: $title, body: ("## ğŸ“‹ æ¦‚è¦\\n\\nIssue #" + $issue_num + " ã®å®Ÿè£…\\n\\n## ğŸ¤– è‡ªå‹•ç”Ÿæˆ\\n\\nClaude AI ç”Ÿæˆ\\n\\n## ğŸ“ å¤‰æ›´å†…å®¹\\n\\nIMPLEMENTATION_SUMMARY.md å‚ç…§\\n\\nCloses #" + $issue_num), head: $head, base: $base}\')\n          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ github.repository }}/pulls" -d "$PR_PAYLOAD"\n```\n\nå¿…ãšã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/claude-feature.yml ã¨ã—ã¦å«ã‚ã¦ãã ã•ã„ã€‚\n\n## é‡è¦ï¼šIssueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å«ã‚ã‚‹\n\nä»¥ä¸‹ã®Issueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š\n\n.github/ISSUE_TEMPLATE/feature_request.yml\n.github/ISSUE_TEMPLATE/bug_report.yml\n.github/ISSUE_TEMPLATE/enhancement.yml\n\nIssueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¦ä»¶ï¼š\n\n### feature_request.yml:\n- name: æ–°æ©Ÿèƒ½ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n- labels: ["feature"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€æœŸå¾…ã™ã‚‹å‹•ä½œã€è¿½åŠ æƒ…å ±ï¼ˆä»»æ„ï¼‰\n\n### bug_report.yml:\n- name: ãƒã‚°å ±å‘Š\n- labels: ["bug"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šãƒã‚°ã®èª¬æ˜ã€å†ç¾æ‰‹é †ã€æœŸå¾…ã™ã‚‹å‹•ä½œã€å®Ÿéš›ã®å‹•ä½œã€ç’°å¢ƒæƒ…å ±ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆä»»æ„ï¼‰\n\n### enhancement.yml:\n- name: æ”¹å–„ææ¡ˆ\n- labels: ["enhancement"]\n- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šæ”¹å–„ã—ãŸã„æ©Ÿèƒ½ã€ææ¡ˆå†…å®¹ã€ãƒ¡ãƒªãƒƒãƒˆ\n\nã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚\n';
          
          console.log(JSON.stringify({
            repo_name: repoName.toLowerCase().replace(/\s+/g, '-'),
            visibility: visibility.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ') ? 'private' : 'public',
            prompt: promptText
          }));
          ENDOFSCRIPT
          
          PARSED=$(node parse-issue.js)
          echo "data<<EOF" >> $GITHUB_OUTPUT
          echo "$PARSED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Call Claude API
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROMPT=$(echo '${{ steps.parse-issue.outputs.data }}' | jq -r '.prompt')
          
          cat > call-claude.js << 'ENDOFSCRIPT'
          const https = require('https');
          
          const prompt = process.env.PROMPT;
          
          const requestData = JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 32000,
            messages: [{
              role: "user",
              content: prompt + '\n\nä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã€èª¬æ˜ä¸è¦ï¼‰:\n\n{\n  "repo_name": "ãƒªãƒã‚¸ãƒˆãƒªå",\n  "description": "1è¡Œã®èª¬æ˜",\n  "files": {\n    "README.md": "å†…å®¹",\n    ".github/workflows/claude-feature.yml": "ä¸Šè¨˜ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…å®¹",\n    ".github/ISSUE_TEMPLATE/feature_request.yml": "æ©Ÿèƒ½ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    ".github/ISSUE_TEMPLATE/bug_report.yml": "ãƒã‚°å ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    ".github/ISSUE_TEMPLATE/enhancement.yml": "æ”¹å–„ææ¡ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",\n    "src/index.js": "å†…å®¹"\n  }\n}\n\nå¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼š\n- .github/workflows/claude-feature.ymlï¼ˆä¸Šè¨˜ã® Enhanced ç‰ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰\n- .github/ISSUE_TEMPLATE/feature_request.yml\n- .github/ISSUE_TEMPLATE/bug_report.yml\n- .github/ISSUE_TEMPLATE/enhancement.yml\n\nã“ã‚Œã‚‰ã¯å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä¸Šè¨˜ã®ä»•æ§˜é€šã‚Šã«ä½œæˆã—ã¦ãã ã•ã„ã€‚'
            }]
          });
          
          const options = {
            hostname: 'api.anthropic.com',
            port: 443,
            path: '/v1/messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(requestData),
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            }
          };
          
          const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(body);
                
                if (response.error) {
                  console.error('API Error:', response.error);
                  process.exit(1);
                }
                
                if (!response.content || !response.content[0]) {
                  console.error('Invalid response structure');
                  process.exit(1);
                }
                
                const content = response.content[0].text;
                
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  try {
                    const parsed = JSON.parse(jsonMatch[0]);
                    console.log(JSON.stringify(parsed, null, 2));
                  } catch (parseError) {
                    console.error('JSON Parse Error:', parseError.message);
                    process.exit(1);
                  }
                } else {
                  console.error('JSON not found in response');
                  process.exit(1);
                }
              } catch (e) {
                console.error('Error:', e.message);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (e) => {
            console.error('Request error:', e.message);
            process.exit(1);
          });
          
          req.write(requestData);
          req.end();
          ENDOFSCRIPT
          
          export PROMPT="$PROMPT"
          CLAUDE_OUTPUT=$(node call-claude.js)
          
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
          VISIBILITY: ${{ fromJSON(steps.parse-issue.outputs.data).visibility }}
        run: |
          REPO_NAME=$(echo "$CLAUDE_OUTPUT" | jq -r '.repo_name')
          REPO_DESC=$(echo "$CLAUDE_OUTPUT" | jq -r '.description')
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$REPO_NAME\",\"description\":\"$REPO_DESC\",\"private\":$([ "$VISIBILITY" = "private" ] && echo true || echo false),\"auto_init\":false}"
          
          sleep 2
          
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
      
      - name: Clone and setup repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@github-actions"
          git config --global init.defaultBranch master
          
          mkdir -p /tmp/new-repo
          cd /tmp/new-repo
          git init
          git branch -M master
          
          echo "$CLAUDE_OUTPUT" | jq -r '.files | to_entries[] | @json' | while read -r entry; do
            filepath=$(echo "$entry" | jq -r '.key')
            content=$(echo "$entry" | jq -r '.value')
            mkdir -p "$(dirname "$filepath")"
            echo "$content" > "$filepath"
          done
          
          git add .
          git commit -m "Initial commit from Issue #${{ github.event.issue.number }}"
          git remote add origin "https://$GITHUB_TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git"
          git push -u origin master
          
          echo "REPO_URL=https://github.com/${{ github.repository_owner }}/$REPO_NAME" >> $GITHUB_ENV
      
      - name: Setup Secrets in new repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          OWNER="${{ github.repository_owner }}"
          
          PUBLIC_KEY_RESPONSE=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/actions/secrets/public-key")
          
          PUBLIC_KEY=$(echo "$PUBLIC_KEY_RESPONSE" | jq -r '.key')
          KEY_ID=$(echo "$PUBLIC_KEY_RESPONSE" | jq -r '.key_id')
          
          cat > encrypt-secret.js << 'ENCRYPTSCRIPT'
          const sodium = require('libsodium-wrappers');
          
          (async () => {
            await sodium.ready;
            
            const publicKey = process.env.PUBLIC_KEY;
            const secret = process.env.SECRET_VALUE;
            
            const binkey = sodium.from_base64(publicKey, sodium.base64_variants.ORIGINAL);
            const binsec = sodium.from_string(secret);
            
            const encBytes = sodium.crypto_box_seal(binsec, binkey);
            const output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL);
            
            console.log(output);
          })();
          ENCRYPTSCRIPT
          
          npm install libsodium-wrappers
          
          export PUBLIC_KEY="$PUBLIC_KEY"
          export SECRET_VALUE="$ANTHROPIC_API_KEY"
          ENCRYPTED_VALUE=$(node encrypt-secret.js)
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/actions/secrets/ANTHROPIC_API_KEY" \
            -d "{\"encrypted_value\":\"$ENCRYPTED_VALUE\",\"key_id\":\"$KEY_ID\"}"
          
          echo "âœ… ANTHROPIC_API_KEY has been added to $REPO_NAME"
      
      - name: Create labels in new repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          OWNER="${{ github.repository_owner }}"
          
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
            -d '{"name":"feature","description":"New feature or request","color":"0e8a16"}'
          
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
            -d '{"name":"bug","description":"Something is not working","color":"d73a4a"}'
          
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
            -d '{"name":"enhancement","description":"Improvement to existing feature","color":"a2eeef"}'
          
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/labels" \
            -d '{"name":"refactor","description":"Code refactoring","color":"fbca04"}'
          
          echo "âœ… Labels created in $REPO_NAME"
      
      - name: Configure Actions permissions in new repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          OWNER="${{ github.repository_owner }}"
          
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/actions/permissions/workflow" \
            -d '{"default_workflow_permissions":"write","can_approve_pull_request_reviews":true}'
          
          echo "âœ… Actions permissions configured for $REPO_NAME"
      
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoUrl = process.env.REPO_URL;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼\n\nğŸ”— [${repoUrl}](${repoUrl})\n\n### ğŸ¤– Enhanced AIæ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™\n\næ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã§Issueã‚’ä½œæˆã™ã‚‹ã¨ã€ClaudeãŒæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã€è‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã‚’è¡Œã£ã¦Pull Requestã‚’ä½œæˆã—ã¾ã™ã€‚\n\n**æ–°æ©Ÿèƒ½ï¼š**\n- âœ… æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã«å¯¾å¿œ\n- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ ãƒ»å‰Šé™¤ã«å¯¾å¿œ\n- âœ… ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«å¯¾å¿œ\n- âœ… ãƒã‚°ä¿®æ­£ã«å¯¾å¿œ\n\n**ä½¿ã„æ–¹ï¼š**\n1. æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã§Issueã‚’ä½œæˆ\n2. "feature", "bug", "enhancement", "refactor" ã®ã„ãšã‚Œã‹ã®ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ \n3. å®Ÿè£…ã—ã¦ã»ã—ã„æ©Ÿèƒ½ã‚„ä¿®æ­£å†…å®¹ã‚’è¨˜è¿°\n4. æ•°åˆ†å¾Œã€è‡ªå‹•ã§PRãŒä½œæˆã•ã‚Œã¾ã™ï¼\n\nClaudeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`
            });
            
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
