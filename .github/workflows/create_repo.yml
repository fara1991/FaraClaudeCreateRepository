name: Create Repository from Issue

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  create-repo:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'create_repo')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Parse issue body
        id: parse-issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat > parse-issue.js << 'ENDOFSCRIPT'
          const issueBody = process.env.ISSUE_BODY;
          
          const extractField = (label) => {
            const regex = new RegExp('### ' + label + '\\s*([\\s\\S]*?)(?=\\n###|$)', 'i');
            const match = issueBody.match(regex);
            return match ? match[1].trim() : '';
          };
          
          const repoName = extractField('ãƒªãƒã‚¸ãƒˆãƒªå');
          const projectType = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—');
          const techStack = extractField('æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯');
          const description = extractField('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜');
          const features = extractField('å¿…è¦ãªæ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰');
          const visibility = extractField('ãƒªãƒã‚¸ãƒˆãƒªã®å…¬é–‹è¨­å®š');
          const license = extractField('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹');
          const notes = extractField('ãã®ä»–ã®è¦æœ›ï¼ˆä»»æ„ï¼‰');
          
          const promptText = '\n# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n## åŸºæœ¬æƒ…å ±\n- ãƒªãƒã‚¸ãƒˆãƒªå: ' + repoName + '\n- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—: ' + projectType + '\n- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ' + techStack + '\n- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: ' + license + '\n\n## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜\n' + description + '\n\n' + (features ? '## å¿…è¦ãªæ©Ÿèƒ½\n' + features + '\n\n' : '') + (notes ? '## ãã®ä»–ã®è¦æœ›\n' + notes + '\n\n' : '') + 'å®Œå…¨ã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\nREADME.mdã«ã¯è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’å«ã‚ã¦ãã ã•ã„ã€‚\n';
          
          console.log(JSON.stringify({
            repo_name: repoName.toLowerCase().replace(/\s+/g, '-'),
            visibility: visibility.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ') ? 'private' : 'public',
            prompt: promptText
          }));
          ENDOFSCRIPT
          
          PARSED=$(node parse-issue.js)
          echo "data<<EOF" >> $GITHUB_OUTPUT
          echo "$PARSED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Call Claude API
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROMPT=$(echo '${{ steps.parse-issue.outputs.data }}' | jq -r '.prompt')
          
          cat > call-claude.js << 'ENDOFSCRIPT'
          const https = require('https');
          
          const prompt = process.env.PROMPT;
          
          const requestData = JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 8000,
            messages: [{
              role: "user",
              content: prompt + '\n\nä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONã®ã¿ã€èª¬æ˜ä¸è¦ï¼‰:\n\n{\n  "repo_name": "ãƒªãƒã‚¸ãƒˆãƒªå",\n  "description": "1è¡Œã®èª¬æ˜",\n  "files": {\n    "README.md": "å†…å®¹",\n    "src/index.js": "å†…å®¹"\n  }\n}'
            }]
          });
          
          const options = {
            hostname: 'api.anthropic.com',
            port: 443,
            path: '/v1/messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(requestData),
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            }
          };
          
          const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
              try {
                const response = JSON.parse(body);
                const content = response.content[0].text;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  const parsed = JSON.parse(jsonMatch[0]);
                  console.log(JSON.stringify(parsed, null, 2));
                } else {
                  console.error('JSON not found');
                  process.exit(1);
                }
              } catch (e) {
                console.error('Error:', e.message);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (e) => {
            console.error('Request error:', e.message);
            process.exit(1);
          });
          
          req.write(requestData);
          req.end();
          ENDOFSCRIPT
          
          export PROMPT="$PROMPT"
          CLAUDE_OUTPUT=$(node call-claude.js)
          
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
          VISIBILITY: ${{ fromJSON(steps.parse-issue.outputs.data).visibility }}
        run: |
          REPO_NAME=$(echo "$CLAUDE_OUTPUT" | jq -r '.repo_name')
          REPO_DESC=$(echo "$CLAUDE_OUTPUT" | jq -r '.description')
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$REPO_NAME\",\"description\":\"$REPO_DESC\",\"private\":$([ "$VISIBILITY" = "private" ] && echo true || echo false)}"
          
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
      
      - name: Clone and setup repository
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.output }}
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@github-actions"
          
          mkdir -p /tmp/new-repo
          cd /tmp/new-repo
          git init
          git branch -M main
          
          echo "$CLAUDE_OUTPUT" | jq -r '.files | to_entries[] | @json' | while read -r entry; do
            filepath=$(echo "$entry" | jq -r '.key')
            content=$(echo "$entry" | jq -r '.value')
            mkdir -p "$(dirname "$filepath")"
            echo "$content" > "$filepath"
          done
          
          git add .
          git commit -m "Initial commit from Issue #${{ github.event.issue.number }}"
          git remote add origin "https://$GITHUB_TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git"
          git push -u origin main
          
          echo "REPO_URL=https://github.com/${{ github.repository_owner }}/$REPO_NAME" >> $GITHUB_ENV
      
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoUrl = process.env.REPO_URL;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼\n\nğŸ”— [${repoUrl}](${repoUrl})\n\nClaudeã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`
            });
            
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
